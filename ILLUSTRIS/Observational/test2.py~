import sqlite3
import os
import sys
import numpy
import random
from numpy import * 
from numpy import linalg
import scipy
from scipy.optimize import brentq
import pylab as pl
import matplotlib.pyplot as plt
import matplotlib.mlab as mlab
import numpy as np

conn = sqlite3.connect('halos_and_subhalos.db')

c = conn.cursor()

# Newton's constant G in km^2 kpc/Msun*s^2 units
G = 6.67e-11 * (1.e-3)**2. * (2.e30)/(3.086e19) 
cutoff = 1.e5
n_bins = 50

velocities_by_range = [[],[],[]]
labels = []
print "Fetching subhalos"
c.execute("SELECT Subhalos.SubhaloID, SubhaloPos.Y, SubhaloPos.Z, SubhaloVel.X, Subhalos.StellarMass FROM SubhaloPos INNER JOIN Subhalos INNER JOIN SubhaloVel WHERE Subhalos.SubhaloID = SubhaloPos.SubhaloID AND SubhaloVel.SubhaloID = Subhalos.SubhaloID")
subhalos = c.fetchall()
print "Done!"
for i in range(1,4):
	print "Range " + `i`
	little = []
	big = []
	# Fetching groups in range
	c.execute("SELECT Groups.GroupID, GroupPos.X, GroupPos.Y, GroupPos.Z, Groups.StellarMass, Groups.Group_R_Crit200, GroupVel.X, Groups.Group_M_Crit200 FROM Groups INNER JOIN Range{index} ON Groups.GroupID = Range{index}.GroupID INNER JOIN GroupVel ON Groups.GroupID = GroupVel.GroupID INNER JOIN GroupPos ON Groups.GroupID = GroupPos.GroupID".format(index = i))
	groups = c.fetchall()
	
	fraction = 2
	barwidth = (30/fraction)+1
	sys.stdout.write("Finding Range{index} satellites...[%s]".format(index = i)%(" " * barwidth))
	sys.stdout.flush()
	sys.stdout.write("\b" * (barwidth+1))
	
	# for j in range(len(groups)):
	for j in range(30): 
	
		groupID   = groups[j][0]
		groupPosX = groups[j][1]	# ckpc/h
		groupPosY = groups[j][2] 
		groupPosZ = groups[j][3]
		groupStellarMass = groups[j][4]	# 10^10 Msun/h
		groupRvir = groups[j][5]	# ckpc/h
		groupVelX = groups[j][6]	# km/s
		groupMvir = groups[j][7]	# 10^10 Msun/h
		
		if j % fraction == 0:
			sys.stdout.write("#") 
			sys.stdout.flush()
		
		
		for subhalo in subhalos:
			subhaloID = subhalo[0]
			subhaloPosY = subhalo[1]
			subhaloPosZ = subhalo[2]
			subhaloVelX = subhalo[3]
			subhaloStellarMass = subhalo[4]
			Dist_condition = (((subhaloPosY - groupPosY)**2)+((subhaloPosZ - groupPosZ)**2))**(0.5) < groupRvir
			Mass_condition = subhaloStellarMass < groupStellarMass
			Vvir = (G*groupMvir/groupRvir * 3e8/1e10)**(0.5)
			Vel_condition = numpy.absolute(subhaloVelX - groupVelX) < Vvir
			if(Dist_condition and Mass_condition and Vel_condition == True):
				velocities_by_range[i-1].append(subhaloVelX)
			if subhaloStellarMass < cutoff:
				little.append(subhaloVelX)
			else:	
				big.append(subhaloVelX)
		
	
	fig, ax = plt.subplots()
	n, bins, patches = ax.hist([little, big], n_bins, normed = 1, histtype = 'stepfilled', stacked = True, label = ["Mstar < {cutoffmass} Msun; $\mu =$ {littlemean}; $\sigma =$ {littlestd}".format(cutoffmass = '%.2e' % cutoff, littlemean = '%.3f'% mean(little), littlestd =  '%.3f'% std(little)), "Mstar > {cutoffmass} Msun; $\mu =$ {bigmean}; $\sigma =$ {bigstd}".format(cutoffmass = '%.2e' % cutoff, bigmean =  '%.3f'%mean(big), bigstd =  '%.3f'%std(big))])
	ax.set_xlabel('Vx (km/s) of satellites')
	ax.set_ylabel('Probability')
	ax.legend(prop = {'size': 10})
	ax.set_title("Range {index}: Comparison of velocity functions of satellites of new and little hosts\n(cutoff = {cutoffmass} Msun)".format(index = i, cutoffmass = '%.2e'%cutoff))
	plt.grid(True)
	fig.set_size_inches(10,10)	
	plt.xlim([-200,200])	
	plt.savefig( "Observational/Range{index}/range{index}_velocity_function_cut_by_mass.png".format(index = i))
	plt.close()		

	labels.append("Range {index}: $\mu =$ {mean}; $\sigma =$ {std}".format(index = i, mean = '%.3f'% mean(velocities_by_range[i-1]), std = '%.3f'% std(velocities_by_range[i-1])))


fig, ax = plt.subplots()
n, bins, patches = ax.hist(velocities_by_range, n_bins, normed = 1, histtype = 'stepfilled', stacked = True, label = labels)
ax.set_xlabel('Vx (km/s) of satellites')
ax.set_ylabel('Probability')
plt.xlim([-200,200])
ax.legend(prop = {'size': 10})
ax.set_title('Velocity function of satellites in different stellar mass ranges')
plt.grid(True)
fig.set_size_inches(10,10)	
plt.savefig("Observational/satellite_velocity_function_by_range.png")
plt.close()
fig, ax = plt.subplots()
	

						
						
			
	
